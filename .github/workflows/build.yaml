name: build

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.arch }}-${{ matrix.libc }}
    runs-on: ${{ matrix.host }}

    strategy:
      matrix:
        include:
          - container: ubuntu:20.04
            libc: glibc
            host: ubuntu-24.04
            arch: amd64
          - container: ubuntu:20.04
            libc: glibc
            host: ubuntu-24.04-arm
            arch: arm64
          - container: alpine:3.12
            libc: musl
            host: ubuntu-24.04
            arch: amd64
          - container: alpine:3.12
            libc: musl
            host: ubuntu-24.04-arm
            arch: arm64

    container:
      image: ${{ matrix.container }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Ubuntu Build
        if: ${{ matrix.container == 'ubuntu:20.04' }}
        run: bash build-ubuntu.sh

      - name: Alpine Build
        if: ${{ matrix.container == 'alpine:3.12' }}
        run: sh build-alpine.sh

      - name: Upload to releases
        uses: svenstaro/upload-release-action@2.11.2
        id: attach_to_release
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        with:
          file: exiftool.exe
          asset_name: exiftool-${{ matrix.arch }}-${{ matrix.libc }}
          tag: ${{ github.ref }}
          overwrite: true
