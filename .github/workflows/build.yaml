name: build

permissions:
  contents: write

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.arch }}-${{ matrix.libc }}
    runs-on: ${{ matrix.host }}

    strategy:
      matrix:
        include:
          - container: ubuntu:20.04
            libc: glibc
            host: ubuntu-24.04
            arch: amd64
          - container: ubuntu:20.04
            libc: glibc
            host: ubuntu-24.04-arm
            arch: arm64
          - container: alpine:3.12
            libc: musl
            host: ubuntu-24.04
            arch: amd64
          - container: alpine:3.12
            libc: musl
            host: ubuntu-24.04-arm
            arch: arm64

    container:
      image: ${{ matrix.container }}

    steps:
      - name: Ubuntu Deps
        if: startsWith(matrix.container, 'ubuntu:')
        run: |
          apt-get update
          apt-get install -y make gcc libperl-dev wget curl sudo unzip zip git gnupg2

          apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          apt-add-repository https://cli.github.com/packages
          apt-get update
          apt-get install -y gh
          gh --version

      - name: Alpine Deps
        if: startsWith(matrix.container, 'alpine:')
        run: |
          echo "http://dl-cdn.alpinelinux.org/alpine/v3.14/community" >> /etc/apk/repositories
          apk update
          apk add bash curl wget make gcc perl perl-utils perl-dev unzip zip musl-dev git github-cli
          gh --version

      - name: Build
        run: |
          git clone https://github.com/${{ github.repository }} repo
          cd repo
          git checkout ${{ github.sha }}
          bash build.sh

      - name: Upload to releases
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mv repo/exiftool.exe ./exiftool-${{ matrix.arch }}-${{ matrix.libc }}
          gh release create ${{ github.ref }} \
            --title "Release ${{ github.ref }}" \
            --notes "Release created by GitHub Actions" \
            --generate-notes \
            --attach exiftool-${{ matrix.arch }}-${{ matrix.libc }} \
            --overwrite
